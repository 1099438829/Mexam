/**
 * @name     Mexam
 * @desc     移动端题库做题插件，只支持，单选题，多选题，判断题
 * @depend   Zepto
 * @author   M.J
 * @date     2015-07-09
 * @URL      http://webjyh.com
 * @reutn    {Mexam}
 * @version  1.0.0
 * @license  MIT
 *
 * @PS If you have any questions, please don't look for me, I don't know anything. thank you.
 */
!function(t,i){"use strict";"function"==typeof define&&define.amd?define(["zepto"],i):"object"==typeof exports?module.exports=i(require("zepto")):t.Mexam=i(t.Zepto)}(this,function(t){"use strict";var i=/scale(?:3d)?\(([^\)]+)\)/,e=/translate(?:3d)?\(([^\)]+)\)/,s=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],n={title:"",data:null,wrap:"body",send:function(){},init:null,close:null},a=['<div class="ui-Mexam-wrapper">',"    <header>",'        <div class="ui-Mexam-back"><a href="javascript:;" class="Mexam-icon ">〈</a></div>','        <h1 class="ui-Mexam-time"><i class="Mexam-icon Mexam-shijian"></i> <span>00:00</span></h1>','        <div class="ui-Mexam-preview"><a href="javascript:;" class="Mexam-icon Mexam-liebiao"></a></div>',"    </header>",'    <div class="ui-Mexam-title">',"        <span><em>01</em>/<i>{{pageCoumt}}</i></span>","        <h3>{{title}}</h3>","    </div>",'    <div class="ui-Mexam-main">','        <div class="ui-Mexam-view"><ul class="ui-Mexam-list"></ul></div>','        <div class="ui-Mexam-card">','        <ul class="ui-Mexam-cardList"></ul>','        <div class="ui-Mexam-buttom"><a href="javascript:;" title="提交">提交</a></div>',"        </div>","    </div>",'    <div class="ui-Mexam-loading ui-Mexam-show"><span class="Mexam-icon Mexam-loading"></span></div>',"</div>"].join(""),r=function(t){return new r.fn.init(t)};return r.fn=r.prototype={constructor:r,init:function(i){i.data&&i.data.length&&(this.config=t.extend(n,i),this.index=0,this.DOM={},this.topics={},this.titleHeight=null,this.next=!1,this.time=0,this.answer=new Array(this.config.data.length),this.resize="number"==typeof window.orientation?"orientationchange.mexam":"resize.mexam",this.screen={width:window.innerWidth,height:window.innerHeight},t.isFunction(this.config.init)&&this.config.init(),this.loadTopics().publish("init").publish("touch").publish("answer").publish("topicJump").publish("events").publish("time"))},formatNumber:function(t){return t.toString().length<2?"0"+t:t},subscribe:function(t,i){return this.topics[t]||(this.topics[t]=[]),this.topics[t].push(i),this},unsubscribe:function(t){return this.topics[t]&&delete this.topics[t],this},publish:function(t){if(!this.topics[t])return!1;var i=this.topics[t],e=i?i.length:0,s=[].slice.call(arguments);s.shift();for(var n=0;e>n;n++)i[n].apply(this,s);return this},create:function(i,e){for(var n="",a='<li style="width: '+this.screen.width+"px; height: "+this.screen.height+'px;"><div><h2>{{title}}</h2>',r="<ol>",h='<li class="{{active}}" data-answer="{{key}}"><span>{{key}}</span><p><span>{{item}}</span></p></li>',o="</ol>",c='<div class="ui-Mexam-buttom"><a href="javascript:;" title="下一题">下一题</a></div>',l=0;e>l;l++){var u=this.answer[i+l]||[],d=this.config.data[i+l];if(!d.content)break;var f=a.replace("{{title}}",d.title)+r;t.each(d.content,function(i,e){var n="",a=s[i];t.inArray(a,u)>-1&&(n="active"),f+=h.replace(/{{key}}/g,a).replace("{{item}}",e).replace("{{active}}",n)}),f+=o,2==d.type&&(f+=c),n+=f+"</div></li>"}return n},getTransform:function(s,n){s=t(s);var a,r,h,o,c=s.css("transform")||s.css("-webkit-transform"),l="none"===c;return"translate"===n?(o=e,(l||!c||-1==c.indexOf(n))&&(l=!0,r=h=0)):"scale"===n&&(o=i,(l||!c||-1==c.indexOf(n))&&(l=!0,r=h=1)),l||(a=c.match(o),a=a[1].split(","),r=parseFloat(a[0]),h=parseFloat(a[1])),{x:r,y:h}},setTransform:function(i,e){if(i){var s,n,a="",r=i.style;for(s in e)n=e[s],a+="translate"===s?" translate3d("+n.x+"px, "+n.y+"px, 0)":"scale"===s?" scale3d("+n.x+", "+n.y+", 1)":n;r.transform=r.webkitTransform=t.trim(a)}},setTransition:function(t,i){if(t){var e,s,n=t.style;for(e in i)s=i[e],s.easing=s.easing||"ease","transform"===e&&(n.transition=n.webkitTransition="-webkit-"+e+" "+s.duration+" "+s.easing),n.transition=n.webkitTransition=e+" "+s.duration+" "+s.easing}},destroy:function(){if(t.isFunction(this.config.close)){var i=this.config.close.apply(this);if(i===!1)return!1}t(this.config.wrap).empty(),t(document).off("touchstart.mexam"),t(window).off(this.resize)},loadTopics:function(){return this.subscribe("init",function(){var i=this,e=t(this.config.wrap),s=a.replace("{{pageCoumt}}",this.formatNumber(this.config.data.length)).replace("{{title}}",this.config.title);e.html(s);var n=e.find("*");n.each(function(e,s){if(s.className.indexOf("ui-Mexam-")>-1){var n=t.trim(s.className.replace("ui-Mexam-","").replace("ui-Mexam-show",""));i.DOM[n]=t(s)}}),this.titleHeight=this.DOM.title.height()+this.DOM.time.height(),t(document).on("touchstart.mexam",function(t){t.preventDefault()})}),this.subscribe("init",function(){var t=this.DOM,i=this.config.data.length>2?3:this.config.data.length,e=this.create(0,i);t.list.css({width:this.screen.width*i,left:0}).html(e),this.setTransition(t.list[0],{transform:{duration:"0ms"}}),this.setTransform(t.list[0],{translate:{x:0,y:0}}),setTimeout(function(){t.loading.removeClass("ui-Mexam-show")},200)}),this.subscribe("init",function(){for(var t=this.DOM.cardList,i="",e='<li data-index="{{index}}"><a href="javascript:;">{{i}}</a></li>',s=this.config.data.length,n=0;s>n;n++)i+=e.replace("{{index}}",n).replace("{{i}}",n+1);t.html(i)}),this.subscribe("preloading",function(t){var i=this.DOM,e=this.config.data.length-1,s="next"==t?this.index+1:this.index-1,n=i.list.children();if(!(0>s||s>e||"next"==t&&1===this.index||"prev"==t&&this.index===e-1)){var a=this.create(s,1);n["next"==t?"first":"last"]().remove(),i.list["next"==t?"append":"prepend"](a)}}),this.subscribe("setPage",function(){this.DOM.title.find("em").text(this.formatNumber(this.index+1))}),this.subscribe("next",function(){var t=this.DOM.list[0],i=this.config.data.length-1,e=this.index===i,s=this.index+1>i?i:this.index+1,n=-(s*this.screen.width);this.next=!0,this.index=s,this.publish("setPage"),e&&this.publish("showCard",!0),this.setTransition(t,{transform:{duration:"300ms",easing:"ease-out"}}),this.setTransform(t,{translate:{x:n,y:0}})}),this.subscribe("touch",function(){var i,e,s,n,a,r,h,o,c=this,l=this.DOM,u=this.config.data.length-1,d=parseInt(this.screen.width/3,10);l.list.on("touchstart",function(r){r.preventDefault(),i=t(r.target).parents("li > div"),e=r.touches[0].clientX,s=r.touches[0].clientY,i.length&&(o=i.height()-c.screen.height+c.titleHeight,n=c.getTransform(i[0],"translate"),a=c.getTransform(this,"translate").x)}),l.list.on("touchmove",function(t){t.preventDefault();var r,o=t.touches[0].clientX,l=t.touches[0].clientY,u=e-o,d=e-o,f=s-l,m=c.index*c.screen.width;if(Math.abs(d)>=Math.abs(f))h=u>0?!0:!1,r=h||0!==c.index?h?-(Math.abs(u)+m):-(m-Math.abs(u)):Math.abs(u),c.setTransition(this,{transform:{duration:"0ms"}}),c.setTransform(this,{translate:{x:r,y:0}});else{if(!i.length||i.height()<c.screen.height-c.titleHeight)return;u=n.y-f,c.setTransform(this,{translate:{x:a,y:0}}),c.setTransition(i[0],{transform:{duration:"0ms"}}),c.setTransform(i[0],{translate:{x:0,y:u}})}}),l.list.on("touchend",function(t){t.preventDefault();var n=t.changedTouches[0].clientX,a=t.changedTouches[0].clientY,l=e-n,f=s-a;if(r=Math.abs(e-n)>d,Math.abs(l)>=Math.abs(f)){r&&(h?c.index++:c.index--),c.index<0&&(c.index=0),c.index>u&&(c.index=u);var m=-(c.index*c.screen.width);c.setTransition(this,{transform:{duration:"300ms",easing:"ease-out"}}),c.setTransform(this,{translate:{x:m,y:0}}),r&&c.publish("setPage")}else{if(!i.length||i.height()<c.screen.height-c.titleHeight)return;var p=c.getTransform(i[0],"translate").y;c.setTransition(i[0],{transform:{duration:"300ms",easing:"ease-out"}}),p>0&&Math.abs(p)>0&&c.setTransform(i[0],{translate:{x:0,y:0}}),0>p&&Math.abs(p)>o&&c.setTransform(i[0],{translate:{x:0,y:-o}})}}),l.list.on("webkitTransitionEnd transtionend",function(){if(r||c.next){c.next&&(h="next"),c.publish("preloading",h?"next":"prev");var i=c.index*c.screen.width-c.screen.width;0===c.index&&(i=0),c.index===c.config.data.length-1&&(i-=c.screen.width),t(this).css("left",0>i?0:i),r=!1,c.next=!1}})}),this.subscribe("answer",function(){function i(t){r.cardList.find("li").eq(h.index)[t?"addClass":"removeClass"]("active")}function e(t){var e=t,s=e.attr("data-answer");h.answer[h.index]=s,e.addClass("active").siblings().removeClass("active"),h.answer&&i(!0),setTimeout(function(){h.publish("next")},200)}function s(e){var s=e,n=h.answer[h.index]||[],a=s.attr("data-answer"),r=t.inArray(a,n);r>-1?n.splice(r,1):n.push(a),n.sort(),h.answer[h.index]=n,s[r>-1?"removeClass":"addClass"]("active"),i(n.length?!0:!1)}var n=!1,a=!1,r=this.DOM,h=this;r.list.on("tap","ol > li",function(i){i.preventDefault();var a=t(this),r=h.config.data[h.index].type;if(!n)switch(n=!0,setTimeout(function(){n=!1},100),r){case 1:case 4:e(a);break;case 2:s(a);break;default:e(a)}}),r.list.on("tap",".ui-Mexam-buttom > a",function(t){t.preventDefault(),a||(a=!0,setTimeout(function(){a=!1,h.publish("next")},200))})}),this.subscribe("topicJump",function(){var i=this.DOM,e=this,s=!1,n=this.config.data.length;i.cardList.on("tap","li",function(a){a.preventDefault();var r,h,o,c=3>n?n:3,l=t(this),u=parseInt(l.text(),10),d=u;s||(3>=n?d=0:(d-=2,(1>d||1===n)&&(d=0),d>=n-2&&(d=n-1-2)),r=e.create(d,c),e.index=u-1,o=e.index*e.screen.width-e.screen.width,h=-(e.index*e.screen.width),0===e.index&&(o=0),e.index===n-1&&(o-=e.screen.width),i.card.removeClass("ui-Mexam-show"),i.list.css("left",0>o?0:o).html(r),e.setTransition(i.list[0],{transform:{duration:"300ms",easing:"ease-out"}}),e.setTransform(i.list[0],{translate:{x:h,y:0}}),e.publish("setPage"),setTimeout(function(){s=!1},100))})}),this.subscribe("showCard",function(t){var i=this.DOM;i.card[t?"addClass":"removeClass"]("ui-Mexam-show")}),this.subscribe("events",function(){var i,e=this.DOM,s=this;e.preview.on("touchstart",function(t){t.preventDefault();var i=e.card.hasClass("ui-Mexam-show");e.card[i?"removeClass":"addClass"]("ui-Mexam-show")}),e.card.on("touchstart",".ui-Mexam-buttom > a",function(i){i.preventDefault();var e=[];if(t.each(s.answer,function(t,i){e.push({id:s.config.data[t].id,answer:i})}),t.isFunction(s.config.send)){var n=s.config.send.apply(s,[e,s.time]);if(n===!1)return!1;s.destroy()}}),e.back.on("touchstart",function(t){t.preventDefault(),s.destroy()}),t(window).on(this.resize,function(){clearInterval(i),i=setTimeout(function(){s.publish("resize")},300)})}),this.subscribe("time",function(){var t=this,i=0,e=0,s=this.DOM.time.find("span"),n=function(){e++,60==e&&(e=0,i++),t.time=60*i+e,s.text(t.formatNumber(i)+":"+t.formatNumber(e))};setInterval(n,1e3)}),this.subscribe("resize",function(){this.next=!1,this.screen={width:window.innerWidth,height:window.innerHeight};var t=this.DOM,i=this.config.data.length>2?3:this.config.data.length,e=this.index*this.screen.width-this.screen.width,s=-(this.index*this.screen.width);0===this.index&&(e=0),this.index===i-1&&(e-=this.screen.width),this.setTransition(t.list[0],{transform:{duration:"0ms"}}),this.setTransform(t.list[0],{translate:{x:s,y:0}}),t.list.css({width:this.screen.width*i,left:e}).children().css({width:this.screen.width,height:this.screen.height}).children().removeAttr("style")}),this}},r.fn.init.prototype=r.fn,r});